# KPI System - Installation Guide

Complete guide for deploying a new copy of the KPI system on a new subdomain with a new Google Sheet.

---

## Table of Contents

1. [Prerequisites](#1-prerequisites)
2. [Create Google Spreadsheet](#2-create-google-spreadsheet)
3. [Deploy Google Apps Script (Write.gs)](#3-deploy-google-apps-script-writegs)
4. [Deploy Google Apps Script (Upload.gs)](#4-deploy-google-apps-script-uploadgs)
5. [Create Subdomain on Server](#5-create-subdomain-on-server)
6. [Upload Files to Server](#6-upload-files-to-server)
7. [Configure the System](#7-configure-the-system)
8. [Initial Data Load](#8-initial-data-load)
9. [Set Up Cron Jobs](#9-set-up-cron-jobs)
10. [Testing](#10-testing)
11. [Troubleshooting](#11-troubleshooting)
12. [File Reference](#12-file-reference)

---

## 1. Prerequisites

- **Hosting**: Apache web server with PHP 7.4+ (PHP 8.x recommended)
  - PHP extensions: `curl`, `json`, `mbstring`
  - `mod_rewrite` enabled
  - `allow_url_fopen = On` in php.ini
- **Google account** with access to Google Sheets and Google Apps Script
- **SSH access** to the server (or FTP/SFTP)
- **Domain name** with DNS management access

---

## 2. Create Google Spreadsheet

### 2.1 Create a new spreadsheet

1. Open [Google Sheets](https://sheets.google.com)
2. Create a new blank spreadsheet
3. Name it: `KPI Database - [Your Location]`
4. Copy the **Spreadsheet ID** from the URL:
   ```
   https://docs.google.com/spreadsheets/d/SPREADSHEET_ID_HERE/edit
   ```
   The ID is the long string between `/d/` and `/edit`

### 2.2 Create required sheets (tabs)

Create the following sheets by clicking the `+` button at the bottom:

**Config sheets (fill manually):**

| Sheet Name | Required Columns |
|---|---|
| `Config_Rooms` | `RoomCode`, `RoomName`, `Active` |
| `Config_Slots` | `SlotCode`, `SlotLabel`, `SlotLabelShort`, `Order`, `Active` |
| `Config_Indicators` | `RoomCode`, `SlotCode`, `Scope`, `Category`, `Indicator`, `Order`, `Active`, `Weight` |
| `Staff` | `StaffId`, `StaffName`, `Role`, `Rooms`, `Active` |

**Data sheets (auto-populated by the system):**

| Sheet Name | Purpose |
|---|---|
| `FormData` | Raw KPI submissions |
| `Staff_Logs` | Staff activity logs |
| `Summary_Day` | Daily aggregated scores |
| `Summary_Month` | Monthly aggregated scores |
| `Summary_Quarter` | Quarterly aggregated scores |
| `Audit_Log` | Audit trail |
| `Errors` | Error log |
| `Debug_Log` | Debug log (optional) |

For data sheets, just create empty sheets with the correct names. Headers will be auto-generated by the system.

### 2.3 Fill Config_Rooms

Example data (row 1 = headers):

| RoomCode | RoomName | Active |
|---|---|---|
| Pink | Pink Room | TRUE |
| Green | Green Room | TRUE |
| Blue | Blue Room | TRUE |
| Admin | Admin | TRUE |

### 2.4 Fill Config_Slots

| SlotCode | SlotLabel | SlotLabelShort | Order | Active |
|---|---|---|---|---|
| 09AM_11AM | 9:00-11:00 AM | 9-11 AM | 1 | TRUE |
| 11AM_01PM | 11:00 AM-1:00 PM | 11-1 PM | 2 | TRUE |
| 01PM_03PM | 1:00-3:00 PM | 1-3 PM | 3 | TRUE |
| 03PM_06PM | 3:00-6:00 PM | 3-6 PM | 4 | TRUE |
| ONCE_DAY | Once a day | Once/day | 5 | TRUE |
| ONCE_MONTH | Once a month | Once/month | 6 | TRUE |

### 2.5 Fill Config_Indicators

| RoomCode | SlotCode | Scope | Category | Indicator | Order | Active | Weight |
|---|---|---|---|---|---|---|---|
| Blue | 09AM_11AM | Team | Safety & Ratio | Check staff-to-child ratios | 1 | TRUE | 5 |
| * | * | Individual | Hygiene & Care | Followed hand-washing protocol | 1 | TRUE | 2 |

**Notes:**
- `RoomCode` = exact room code OR `*` for all rooms
- `SlotCode` = exact slot code OR `*` for all slots
- `Scope` = `Team` or `Individual`
- `Weight` = importance multiplier (default 1). Recommended: Safety=5, Hygiene=2, Other=1

### 2.6 Fill Staff

| StaffId | StaffName | Role | Rooms | Active |
|---|---|---|---|---|
| st_john | JOHN DOE | Teacher | Pink | TRUE |
| st_jane | JANE SMITH | Assistant | Blue | TRUE |
| st_admin | ADMIN USER | Office | Admin | TRUE |

**Notes:**
- `StaffId` must be unique (use prefix `st_`)
- `Rooms` = single room code that this staff member belongs to

---

## 3. Deploy Google Apps Script (Write.gs)

This script serves configuration data to the frontend.

### 3.1 Create the script

1. In your Google Spreadsheet, go to **Extensions > Apps Script**
2. Delete default `Code.gs` content
3. Rename file to `Write.gs`
4. Paste the contents of `Google Apps Script/Write.gs` from this repository
5. **Replace** `SS_ID` value with your Spreadsheet ID from step 2.1:
   ```javascript
   const SS_ID = 'YOUR_SPREADSHEET_ID_HERE';
   ```

### 3.2 Deploy as Web App

1. Click **Deploy > New deployment**
2. Click the gear icon, select **Web app**
3. Settings:
   - Description: `KPI Read API`
   - Execute as: **Me** (your email)
   - Who has access: **Anyone**
4. Click **Deploy**
5. Authorize when prompted (review permissions, click Allow)
6. **Copy the Web App URL** - this is your `KPI_GAS_READ_URL`
   ```
   https://script.google.com/macros/s/XXXXXX/exec
   ```

---

## 4. Deploy Google Apps Script (Upload.gs)

This script receives KPI data from the frontend and writes to Sheets.

### 4.1 Create a NEW Apps Script project

**Important:** This must be a SEPARATE Apps Script project from Write.gs.

1. Go to [script.google.com](https://script.google.com)
2. Click **New project**
3. Name it: `KPI Upload Backend`
4. Paste the contents of `Google Apps Script/Upload.gs`
5. **Replace** `SPREADSHEET_ID` with your Spreadsheet ID:
   ```javascript
   const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID_HERE';
   ```

### 4.2 Deploy as Web App

1. Click **Deploy > New deployment**
2. Settings:
   - Description: `KPI Upload API`
   - Execute as: **Me**
   - Who has access: **Anyone**
3. Click **Deploy** and authorize
4. **Copy the Web App URL** - this is your `KPI_GAS_UPLOAD_URL`

### 4.3 Important notes about GAS deployments

- Each time you edit the script, you need to create a **new deployment** (Deploy > New deployment) for changes to take effect
- The URL changes with each new deployment
- To update without changing the URL: Deploy > Manage deployments > Edit existing deployment > set Version to "New version"
- If GAS returns HTML instead of JSON, recheck: Execute as "Me", Access "Anyone"

---

## 5. Create Subdomain on Server

### 5.1 DNS configuration

Add an A record in your DNS provider:

```
Type: A
Name: kpi (or your chosen subdomain)
Value: YOUR_SERVER_IP
TTL: 300
```

Wait for DNS propagation (5-30 minutes).

### 5.2 Create subdomain in hosting panel

**Option A: cPanel**

1. Login to cPanel
2. Go to **Domains** > **Subdomains** (or **Domains** > **Create a New Domain**)
3. Subdomain: `kpi` (or your choice)
4. Domain: `yourdomain.com`
5. Document Root: `/home/username/kpi.yourdomain.com/public_html`
   (or `/home/username/public_html/kpi` for subdirectory)
6. Click **Create**

**Option B: Command line (Apache)**

```bash
# Create directory
sudo mkdir -p /var/www/kpi.yourdomain.com/public_html
sudo chown -R www-data:www-data /var/www/kpi.yourdomain.com

# Create virtual host
sudo nano /etc/apache2/sites-available/kpi.yourdomain.com.conf
```

Virtual host config:
```apache
<VirtualHost *:80>
    ServerName kpi.yourdomain.com
    DocumentRoot /var/www/kpi.yourdomain.com/public_html

    <Directory /var/www/kpi.yourdomain.com/public_html>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/kpi-error.log
    CustomLog ${APACHE_LOG_DIR}/kpi-access.log combined
</VirtualHost>
```

```bash
sudo a2ensite kpi.yourdomain.com.conf
sudo systemctl reload apache2
```

### 5.3 SSL certificate (recommended)

```bash
sudo certbot --apache -d kpi.yourdomain.com
```

Or use cPanel's AutoSSL / Let's Encrypt integration.

---

## 6. Upload Files to Server

### 6.1 Clone or copy files

**Option A: Git clone**
```bash
cd /path/to/your/webroot
git clone https://github.com/YOUR_REPO/KPI-TE.git .
```

**Option B: Manual upload via SFTP**

Upload these files to your web root directory:

```
public_html/
  index.html          # Main KPI checklist (uses proxy.php -> GAS directly)
  index1.html         # Alternative version (uses local data.json + proxy2.php)
  proxy.php           # Direct GAS proxy
  proxy2.php          # Local queue proxy
  sync.php            # Queue -> GAS sync worker
  sync_runner.php     # Automated retry runner
  update.php          # Data refresh UI
  health.php          # System health check
  syncstart.php       # Manual sync UI
  config.sample.php   # Config template
  .htaccess           # Apache security rules
  logo.svg            # Logo
  samples.jpg         # Hero image
```

### 6.2 Set file permissions

```bash
cd /path/to/your/webroot

# PHP files: read-only for web server
chmod 644 *.php *.html .htaccess

# Config must be readable by PHP
chmod 640 config.php

# Data files need read+write by web server
touch store.json data.json
chmod 666 store.json data.json

# Or better, use the web server user:
chown www-data:www-data store.json data.json
chmod 664 store.json data.json
```

---

## 7. Configure the System

### 7.1 Create config.php

```bash
cp config.sample.php config.php
nano config.php
```

Fill in your values:

```php
<?php
// GAS Read URL (from step 3.2)
define('KPI_GAS_READ_URL', 'https://script.google.com/macros/s/YOUR_READ_ID/exec');

// GAS Upload URL (from step 4.2)
define('KPI_GAS_UPLOAD_URL', 'https://script.google.com/macros/s/YOUR_UPLOAD_ID/exec');

// Local file paths (usually no change needed)
define('KPI_STORE_FILE', __DIR__ . '/store.json');
define('KPI_DATA_FILE', __DIR__ . '/data.json');

// Sync settings
define('KPI_SYNC_MAX_ATTEMPTS', 100);
define('KPI_SYNC_DELAY_SEC', 30);
define('KPI_SYNC_BATCH_SIZE', 100);
define('KPI_MAX_ENTRY_RETRIES', 10);

// Auth token (generate with: php -r "echo bin2hex(random_bytes(32));")
// Leave empty to disable auth
define('KPI_AUTH_TOKEN', '');

// CORS origin
define('KPI_CORS_ORIGIN', '*');

// Log settings
define('KPI_LOG_DIR', __DIR__);
define('KPI_LOG_MAX_SIZE', 5 * 1024 * 1024);

// Debug mode
define('KPI_DEBUG', false);
```

### 7.2 Choose your frontend version

The system has two frontend modes:

**Mode A: Direct GAS proxy (index.html)**
- Frontend calls `proxy.php` which forwards directly to GAS
- Simpler, but depends on GAS being available
- Best for: reliable internet, small teams

**Mode B: Local queue (index1.html)**
- Frontend calls `proxy2.php` which stores locally in `store.json`
- Data syncs to GAS via `sync.php` / `sync_runner.php`
- Best for: unreliable internet, offline-first

To switch the default page:
```bash
# Use Mode B as default:
cp index1.html index.html
```

### 7.3 Configure frontend URLs (if needed)

In `index.html`, check these constants match your setup:
```javascript
const WEBAPP_URL = '/kpi/proxy.php';  // or just 'proxy.php' if at root
```

In `index1.html`:
```javascript
const DATA_URL = '/kpi/data.json';     // adjust path
const API_URL = '/kpi/proxy2.php';     // adjust path
const UPDATE_URL = '/kpi/update.php?run=1';
```

If your files are at the root of the subdomain (not in a `/kpi/` subfolder), remove the `/kpi/` prefix:
```javascript
const WEBAPP_URL = 'proxy.php';
const DATA_URL = 'data.json';
const API_URL = 'proxy2.php';
const UPDATE_URL = 'update.php?run=1';
```

---

## 8. Initial Data Load

### 8.1 Fetch config data from GAS

Open your browser and visit:
```
https://kpi.yourdomain.com/update.php
```

Click **"Update Data"**. This will:
1. Call Write.gs to get all config data from Sheets
2. Save it to `data.json`
3. Show counts of rooms, slots, indicators, staff

If you see an error:
- Check that `KPI_GAS_READ_URL` in config.php is correct
- Check that Write.gs is deployed as Web App with correct permissions
- Try the GAS URL directly in a browser to verify it returns JSON

### 8.2 Verify the system

Open your browser and visit:
```
https://kpi.yourdomain.com/
```

You should see the KPI Checklist start screen. Click "Start new check" and verify:
- Rooms load correctly
- Time slots load correctly
- Staff loads when you select a room
- Indicators load when you click "Show checklist"

### 8.3 Test a full submission

1. Select a room, slot, date, and staff
2. Click "Show checklist" for Team KPI
3. Fill in a few indicators and click "Confirm Selection"
4. Choose "No" for individual breaches
5. Click "Confirm & Finish"
6. Check your Google Sheet - `FormData` tab should have new rows

---

## 9. Set Up Cron Jobs

### 9.1 Auto-refresh config data

Update `data.json` from Google Sheets every minute:

```bash
crontab -e
```

Add:
```cron
# Refresh KPI config from GAS every minute
* * * * * curl -s "https://kpi.yourdomain.com/update.php?run=1" > /dev/null 2>&1
```

### 9.2 Auto-sync pending data (Mode B only)

If using local queue mode (proxy2.php), sync pending entries every hour:

```cron
# Sync KPI pending data to GAS every hour
0 * * * * php /path/to/webroot/sync_runner.php >> /path/to/webroot/sync_runner.log 2>&1
```

### 9.3 Log rotation (optional)

Add daily log rotation:

```cron
# Rotate KPI logs daily at midnight
0 0 * * * find /path/to/webroot/ -name "*.log" -size +5M -exec truncate -s 0 {} \;
```

---

## 10. Testing

### 10.1 Health check

```bash
curl -s https://kpi.yourdomain.com/health.php | python3 -m json.tool
```

Expected output:
```json
{
  "ok": true,
  "checks": {
    "store_writable": true,
    "pending_count": 0,
    "dead_letter_count": 0,
    "data_exists": true,
    "data_valid": true,
    "data_counts": {
      "rooms": 4,
      "slots": 6,
      "indicators": 200,
      "staff": 8
    },
    "gas_read_url_set": true,
    "gas_upload_url_set": true,
    "auth_enabled": false,
    "php_version": "8.1.x",
    "timestamp": "2026-02-11T..."
  }
}
```

### 10.2 Test proxy connection

```bash
# Test direct GAS read
curl -s "https://kpi.yourdomain.com/update.php?run=1" | python3 -m json.tool

# Test proxy -> GAS write (should return error about missing action, which proves connectivity)
curl -s -X POST https://kpi.yourdomain.com/proxy.php \
  -H 'Content-Type: application/json' \
  -d '{"action":"getConfig","payload":{}}' | python3 -m json.tool
```

### 10.3 Test local queue (Mode B)

```bash
# Write test entry to queue
curl -s -X POST "https://kpi.yourdomain.com/proxy2.php?fn=test" \
  -H 'Content-Type: application/json' \
  -d '{"test": true}' | python3 -m json.tool

# Check health - should show pending_count: 1
curl -s https://kpi.yourdomain.com/health.php | python3 -m json.tool

# Trigger sync
php /path/to/webroot/sync.php
```

### 10.4 Full end-to-end test

1. Open the KPI checklist in browser
2. Complete a full check (Team + Individual)
3. Verify data appears in Google Sheets (FormData tab)
4. Open `update.php` and refresh data
5. Run `health.php` and verify all green

---

## 11. Troubleshooting

### GAS returns "Missing or invalid ?action=getAll"
- Check that the Write.gs URL is used for `KPI_GAS_READ_URL` (not Upload.gs)
- Verify the deployment is active: Apps Script > Deploy > Manage deployments

### GAS returns HTML instead of JSON
- Redeploy: Apps Script > Deploy > New deployment
- Check permissions: Execute as "Me", Access "Anyone"

### "Failed to fetch from GAS" in update.php
- Check `allow_url_fopen = On` in php.ini
- Or install/enable php-curl extension

### store.json permission denied
```bash
chmod 666 store.json
# or
chown www-data:www-data store.json
```

### Data not appearing in Google Sheets
1. Check `sync.php` output: `php sync.php`
2. Check `store.json` for dead-letter entries
3. Verify `KPI_GAS_UPLOAD_URL` is correct
4. Check GAS execution logs: Apps Script > Executions

### CORS errors in browser
- Verify `KPI_CORS_ORIGIN` in config.php
- For development, use `'*'`
- For production, set to your exact domain: `'https://kpi.yourdomain.com'`

### "Unauthorized" error
- If `KPI_AUTH_TOKEN` is set, pass the token:
  - URL: `?token=YOUR_TOKEN`
  - Header: `X-Auth-Token: YOUR_TOKEN`
- To disable auth: set `KPI_AUTH_TOKEN` to empty string `''`

---

## 12. File Reference

### PHP Files

| File | Purpose |
|---|---|
| `config.php` | Centralized configuration (GAS URLs, auth, paths) |
| `config.sample.php` | Template for config.php |
| `proxy.php` | Direct CORS proxy to GAS (for Mode A) |
| `proxy2.php` | Local queue proxy with file locking (for Mode B) |
| `sync.php` | Sends pending queue entries to GAS |
| `sync_runner.php` | Retry loop for sync.php |
| `update.php` | Fetches config from GAS -> data.json |
| `health.php` | System health check endpoint |
| `syncstart.php` | Manual sync trigger UI |

### Frontend Files

| File | Purpose |
|---|---|
| `index.html` | Main KPI checklist (Mode A: direct GAS) |
| `index1.html` | Alternative KPI checklist (Mode B: local queue) |
| `logo.svg` | Company logo |
| `samples.jpg` | Start screen image |

### Google Apps Script

| File | Purpose | Deployment |
|---|---|---|
| `Google Apps Script/Write.gs` | Read API (getAll config data) | Separate Web App |
| `Google Apps Script/Upload.gs` | Write API (save KPI, rebuild summaries) | Separate Web App |

### Data Files (auto-generated, not in git)

| File | Purpose |
|---|---|
| `data.json` | Local snapshot of config from GAS |
| `store.json` | Pending queue for async sync |

### Google Sheets Structure

| Sheet | Purpose |
|---|---|
| `Config_Rooms` | Room definitions |
| `Config_Slots` | Time slot definitions |
| `Config_Indicators` | KPI indicators with weights |
| `Staff` | Staff list with room assignments |
| `FormData` | Raw KPI submissions |
| `Staff_Logs` | Per-staff activity log |
| `Summary_Day` | Daily scores (auto-computed) |
| `Summary_Month` | Monthly scores (auto-computed) |
| `Summary_Quarter` | Quarterly scores (auto-computed) |
| `Audit_Log` | System audit trail |
| `Errors` | Error log |
| `Debug_Log` | Debug log |

---

## Quick Start Checklist

- [ ] Created Google Spreadsheet with all required sheets
- [ ] Filled Config_Rooms, Config_Slots, Config_Indicators, Staff
- [ ] Deployed Write.gs as Web App and copied URL
- [ ] Deployed Upload.gs as Web App and copied URL
- [ ] Created subdomain with DNS A record
- [ ] SSL certificate installed
- [ ] Files uploaded to web root
- [ ] `config.php` created from `config.sample.php` with correct URLs
- [ ] File permissions set (666 for store.json, data.json)
- [ ] `update.php` successfully loaded data
- [ ] KPI checklist UI loads and shows rooms/slots/staff
- [ ] Test submission appears in Google Sheets FormData
- [ ] Cron jobs configured (update + sync)
- [ ] `health.php` shows all green
