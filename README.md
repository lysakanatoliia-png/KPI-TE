Технічна документація KPI Tinyeinstein
Сторнка доступна за адресою https://dev.tinyeinstein.org/

Є дві допоміжні сторінки з кнопками щоб вручну оновляти дані:
https://dev.tinyeinstein.org/update.php записує дані з бази даних в панель. Виставлено автооновлення щохвилини
б) https://dev.tinyeinstein.org/syncstart.php надсилає накопичені дані з локальної бази на базу даних в таблицях. Автовиклик щогодини.
3. Все реалізовано за допомогою скриптів та файлів що знаходяться на сервері dev.tinyeinstein.org/public_html
a)index.html 
Файл: Admin KPI Checklist (HTML + CSS + JS)
Призначення:
 Це головна веб-сторінка для адміністратора дитячого центру. Вона використовується для перевірки та фіксації ключових показників (KPI) як на рівні команди (Team), так і на рівні окремих співробітників (Individual).
Як працює:
UI та стилі (HTML/CSS):


Є стартовий екран з логотипом, картинкою та кнопкою «Start new check».


Основна форма складається з полів: кімната, часовий слот, дата та список співробітників.


Для зручності реалізовані кастомні випадаючі списки (multi dropdown) і таблиці для введення KPI.


Автоматично підтягуються кольорові теми (pink/green/blue) залежно від кімнати.


Інтерактивні кнопки з індикаторами завантаження, валідацією і блокуванням під час збереження.


JS-логіка:


Логування подій (DEBUG-режим).


Завантаження даних (кімнати, слоти, співробітники, індикатори) з локального JSON (/kpi/data.json) та оновлення через API (proxy2.php, update.php).


Формування payload та збереження KPI через бекенд API (saveTeamKPI, saveIndividualKPI, finalizeBatch).


Обробка команд KPI:


Team KPI: показує чек-лист індикаторів для всієї команди, вимагає коментарів при “Not checked”.


Individual KPI: при виявлених порушеннях дозволяє вибрати співробітника і пройти окремий чек-лист.


Finish: якщо немає порушень — швидке завершення та відправка даних.


Захист від помилок: перехоплення JS-помилок та unhandled promise rejection.


Динамічна робота з DOM: оновлення елементів інтерфейсу, показ/приховування блоків, повідомлення про помилки.


Де використовується:
Інтерфейс для адміністратора у дитячому садочку Tiny Einstein Child Development Center.


Дає змогу щодня проводити контроль якості роботи персоналу (кімнати, зміни, співробітники).


Дані зберігаються через бекенд і потрапляють у KPI-систему (Google Apps Script + база).


Фронтенд адаптований для десктопа та мобільних пристроїв (адаптивні стилі).
б) logo.svg логотип






в) samples.jpg картинка на головній 




г)Файл: proxy2.php
Призначення:
 Цей PHP-скрипт виконує роль локального проксі. Він приймає запити від фронтенду (замість прямої відправки у Google Apps Script), зберігає їх у локальному файлі store.json, щоб далі можна було відправити всі події пакетами чи із затримкою. Це забезпечує надійність: навіть якщо зв'язок із GAS тимчасово недоступний, дані не губляться.
Як працює:
Читає параметри запиту:


fn (action) з GET-параметра — вказує, яку операцію викликав фронт.


JSON-payload із тіла POST — фактичні дані, які треба зберегти.


Перевірка валідності:
 Якщо відсутня дія або payload, скрипт повертає помилку у форматі JSON.


Генерує унікальний ідентифікатор події (entryId):


Основний варіант — 32-символьний криптостійкий hex (через random_bytes).


Резервний варіант — uniqid() з префіксом.


Готує локальне сховище (store.json):


Читає наявний файл (якщо є).


Якщо секції pending ще нема — створює її.


Додає подію у список pending:
 Зберігає структуру:

 {
  "fn": "назва дії",
  "payload": { ... },
  "ts": "час у UTC",
  "sent": false
}


Оновлює файл store.json:
 Записує всі дані назад у JSON з гарним форматуванням.


Відповідає фронтенду:
 Повертає JSON із підтвердженням, унікальним entryId, кількістю подій у черзі та статусом ok: true.


Де використовується:
Використовується у KPI-системі як буфер збереження даних між фронтендом та Google Apps Script.


Гарантує, що всі дії (збереження Team KPI, Individual KPI тощо) не губляться при збоях у мережі.


Далі окремий процес (наприклад, sync.php чи runner) відправляє ці дані у GAS централізовано.
д) Файл: sync.php
Призначення:
 Скрипт відповідає за синхронізацію локально збережених подій із Google Apps Script (GAS). Він відправляє накопичені у store.json записи на сервер і очищає їх з локальної черги.
Як працює:
Підготовка сховища:


Читає дані з store.json.


Якщо файл порожній або відсутній — створює пустий масив pending.


Вибір подій для відправки:


Береться максимум 100 подій з черги (щоб не перевантажувати GAS).


Відправка подій у GAS:


Для кожної події формує JSON-об’єкт:

 {
  "action": "назва дії (fn)",
  "payload": { ... }
}


Використовує cURL для POST-запиту на адресу GAS (GAS_URL).


Якщо бекенд відповідає {"ok": true}, подія вважається успішно доставленою.


Очищення черги:


Незалежно від результату (OK чи FAIL) подія видаляється з pending.


Після проходження всіх записів зберігає оновлений store.json (переіндексовує масив).


Логування в консоль:


[OK] fn batchId — подія успішно відправлена.


[FAIL] fn batchId — подія не підтверджена бекендом.


Після завершення виводить кількість записів, що залишились у черзі.


Де використовується:
Виконується як сервісний скрипт на сервері (можна запускати через cron).


Забезпечує передачу всіх локально збережених KPI-записів (через proxy2.php) у центральну систему GAS.


Дає змогу працювати навіть при тимчасовій відсутності інтернету або збої зв’язку з GAS, бо всі події гарантовано потраплять у систему після запуску sync.php
е)Файл: sync_runner.php
Призначення:
 Автоматизує повторну відправку даних у GAS. Скрипт циклічно запускає sync.php, доки в локальному сховищі store.json залишаються необроблені записи (pending).
Як працює:
Константи:


MAX_ATTEMPTS – максимальна кількість повторних запусків (за замовчуванням 20).


DELAY_SEC – затримка між циклами у секундах (за замовчуванням 30).


Перевірка наявності подій:


Функція hasPending() дивиться у файл store.json.


Якщо у секції pending є записи — синхронізацію потрібно продовжувати.


Циклічний запуск:


У циклі виконує sync.php (через passthru).


Після кожного запуску перевіряє: якщо pending порожній → завершення роботи.


Якщо події ще залишилися → робить паузу DELAY_SEC і пробує знову.


Умова виходу:


Якщо всі події успішно відправлені → повідомляє “All pending entries sent!”.


Якщо досягнуто MAX_ATTEMPTS, але записи лишилися → повідомляє “Reached MAX_ATTEMPTS, still pending left.”.


Де використовується:
Виконується як довготривалий процес (можна запускати вручну або через cron/systemd).


Забезпечує, що навіть якщо синхронізація не вдалася з першого разу (помилки мережі, тимчасова недоступність GAS), система повторюватиме спроби.


Підходить для гарантованої доставки даних KPI з локального store.json у центральний бекенд GAS.
є) Проміжні файли data.json локальна база даних для виведення даних у веб панель store.json локальна база даних для збереження даних по працівках кімнатах таймслоьах…
4. скріпти на AppScript 
Файл: Write.gs (GAS) – getAll
Призначення:
 Це веб-ендпоінт Google Apps Script, який віддає у форматі JSON всі довідкові дані з таблиці Google Sheets (кімнати, часові слоти, KPI-індикатори, співробітники). Використовується фронтендом та бекенд-проксі, щоб отримати актуальні конфігураційні дані.
Як працює:
Константа SS_ID:


ID Google Таблиці, з якої читаються дані.


Функція doGet(e):


Відповідає на HTTP GET-запити.


Якщо в URL є ?action=getAll → викликає getAllData().


Якщо параметр відсутній або неправильний → повертає JSON з помилкою.


Всі відповіді повертаються у MIME-типі application/json.


Якщо стається виключення → повертає JSON з текстом помилки.


Функція getAllData():


Відкриває таблицю за SS_ID.


Перевіряє, що існують потрібні аркуші:


Config_Rooms


Config_Slots


Config_Indicators


Staff


Зчитує їх через getSheetData().


Формує об’єкт із даними та службовою інформацією (version, ssId, ssName, generatedAt).


Приклад структури відповіді:

 {
  "rooms": [...],
  "slots": [...],
  "indicators": [...],
  "staff": [...],
  "_meta": {
    "ok": true,
    "version": "v1",
    "ssId": "1TKaz...",
    "ssName": "KPI Database",
    "generatedAt": "2025-09-26T12:34:56.789Z"
  }
}


Функція getSheetData(ss, sheetName):


Читає заголовки (перший рядок) і всі наступні дані.


Формує масив об’єктів виду { "HeaderName": "Value", ... }.


Пропускає порожні рядки.


Якщо даних немає → повертає порожній масив.


Де використовується:
Це основне джерело даних для KPI Checklist UI (HTML/JS фронтенд).


Забезпечує централізоване зберігання конфігурації: кімнати, таймслоти, індикатори, персонал.


Викликається через fetch() із фронту або через PHP-проксі (update.php).


Дає можливість швидко змінювати конфігурацію в Google Sheets без перерозгортання коду.
Файл: Upload.gs (Google Apps Script)
Призначення:
 Цей скрипт є бекенд-частиною KPI-системи на базі Google Apps Script. Він отримує дані з фронтенду (через doPost), зберігає їх у Google Sheets, веде журнали (аудит, помилки, debug) та формує зведені показники (щоденні, місячні, квартальні).

Як працює:
Налаштування та константи


SPREADSHEET_ID – ID основної Google-таблиці.


SHEETS – перелік аркушів (FormData, Staff_Logs, Summary_Day, Summary_Month, Summary_Quarter, Errors, Debug_Log тощо).


TZ, VERSION, DEBUG_VERBOSE – часовий пояс, версія бекенду, режим логування.


Утиліти та логування


nowIso() – формує timestamp у заданому часовому поясі.


uuid() – генерує унікальний ID запису.


logDebug(), logError(), audit() – записують у відповідні аркуші (Debug_Log, Errors, Audit_Log).


readTable() – читає дані з аркуша у вигляді {cols, rows}.


ensureHeader() – створює заголовки у аркушах, якщо вони порожні.


HTTP-обробка (API-ендпоінт)


doPost(e) приймає JSON-запит з action і payload.


Підтримує дії:


saveTeamKPI


saveIndividualKPI


finalizeBatch (фактично викликає повний перерахунок summary)


rebuildSummaries


Повертає відповідь у JSON.


Збереження даних


saveTeamKPI(payload)


Записує оцінки KPI для всієї команди у аркуші FormData і Staff_Logs.


Перевіряє дублікати за ключами (BatchID+Date+Room+Slot+Staff+Indicator).


Формує рядки у форматі: [EntryID, BatchID, Timestamp, Date, RoomCode, SlotCode, StaffId, StaffName, Category, Indicator, Check, Value, Comment, SourceVersion].


Після запису запускає перерахунок summary.


saveIndividualKPI(payload)


Аналогічно, але для окремих співробітників.


Якщо items не передані, бере індикатори з Config_Indicators для відповідної кімнати/слоту.


Якщо порожній presentStaffIds, то використовує payload.member.staffId.


Записує у FormData і Staff_Logs.


Формування зведених даних (Summaries)


_allCategories() – збирає унікальні категорії KPI.


recomputeSummary(level) – перераховує дані для day, month, quarter:


групує по даті/місяцю/кварталу, кімнаті та співробітнику.


для кожної категорії рахує середній % виконання (0/1 → %)


якщо індикатор стосується кімнати, але немає записів → вважає 100%.


підсумковий показник розраховується з вагами: Team 80% + Individual 20%.


recomputeSummaryDay(), recomputeSummaryMonth(), recomputeSummaryQuarter() – зберігають результати у відповідні аркуші.


Фіналізація


finalizeFullRebuild(meta)


Виконує перерахунок усіх summary (Day, Month, Quarter).


Логує результат в Audit.


rebuildSummaries() – просто обгортка над finalizeFullRebuild().



Де використовується:
Це основний бекенд KPI-системи дитячого центру Tiny Einstein.


Приймає дані з фронтенду (через PHP-проксі або напряму).


Зберігає всі події у Google Sheets (повна історія + журнали + помилки).


Автоматично формує щоденні, місячні та квартальні звіти.


Дозволяє адміністрації бачити прогрес, проблеми та якість роботи як на рівні команди, так і окремих співробітників.





# KPI-TE
